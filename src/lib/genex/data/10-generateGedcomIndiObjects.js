/**
 * Collects GEDCOM INDI info into a JSON object for subsequent diagnostics and processing.
 * This allows checking for multiple/conflicting NAME, SEX, BIRT, DEAT, FAMC info.
 */
// Modules
import fs from 'fs'
import { constructGedcomNestedRecords } from '../gedcom/constructGedcomNestedRecords.js'
import { constructGedcomINDIBlock, block2Json, fmtINDIBlock, checkMultipleRecords, applyPreferredData } from '../gedcom/constructGedcomINDIBlock.js'
// Data
import { _filteredRecords } from './generated/gedcom/_filteredRecords.js'
import { _gedcomResolvedDuplicates } from './customized/_gedcomResolvedDuplicates.js'

const samuelBevins = '@I292505359674@'
const williamLongfordBevins = '@I292505366205@'

const time1 = new Date()
const progName = (process.argv[1]).split('\\').pop()
const inputFile = './generated/gedcom/_filteredRecords.js'
const resolvedFile = './customized/_gedcomResolvedDuplicates.js'
const multiplesName = '_unresolvedDuplicatesINDI'
const multiplesFile = `./diagnostics/gedcom/${multiplesName}.js`
const outputName = '_indiObjects'
const outputFile = `./generated/gedcom/${outputName}.js`

// Use a GedcomNestedRecords instance since it handles all parsing, CONC, and CONT
const gedcom = constructGedcomNestedRecords(_filteredRecords)
const map = gedcom.topLevelRecordsFor('INDI')
const blocks = Array.from(map.entries())
const resolvedMap = new Map(_gedcomResolvedDuplicates)
const multiples = []
const json = []
for(let i=0; i<blocks.length; i++) {
    let block = constructGedcomINDIBlock(gedcom, blocks[i]) // blocks[i] is the head record
    block = applyPreferredData(block, resolvedMap)
    
    const mult = checkMultipleRecords(block)
    for(let i=0; i<mult.length; i++) multiples.push(mult[i])
    if (mult.length) multiples.push('')

    const js = block2Json(block)
    for(let i=0; i<js.length; i++) json.push(js[i])
}

let head = [
    `// auto-generated by ${progName} on ${new Date().toLocaleString()}`,
    `// from FILTERED GEDCOM JSON records file '${inputFile}'`,
    `// Indicate preferred by copying each block into ${resolvedFile}`,
    `export const ${multiplesName} = [`
]
let js = head.join('\n') + '\n' + multiples.join('\n') + ']\n'
fs.writeFile(multiplesFile, js, function (err) { if (err) throw err })
    
head = [
    `// auto-generated by ${progName} on ${new Date().toLocaleString()}`,
    `// from FILTERED GEDCOM JSON records file '${inputFile}'.`,
    `export const ${outputName} = [`
]
js = head.join('\n') + '\n' + json.join('\n') + ']\n'
fs.writeFile(outputFile, js, function (err) { if (err) throw err })

console.log(`\n${progName}`)
console.log(`    1 - read ${_filteredRecords.length} [<GEDCOM record>] elements from '${inputFile}'.`)
console.log(`    2 - wrote ${blocks.length} INDI instances into '${outputFile}'.`)
console.log(`    3 - wrote ${multiples.length} multiple record option elements into '${multiplesFile}'.`)
console.log(`    Successfully completed in ${new Date()-time1} msec`)
