import fs from 'fs'
import { parseRecord } from '../gedcom/parseRecord.js'
import { _filteredRecords } from './generated/gedcom/_filteredRecords.js'
import { _gedcomKnownPlaces } from './customized/_gedcomKnownPlacesMASTER.js'
import { _vicinities } from './customized/genex/_vicinities.js'

const time1 = new Date()
const progName = (process.argv[1]).split('\\').pop()
const masterFile = './customized/_gedcomKnownPlacesMASTER.js'
const inputFile = './generated/gedcom/_filteredRecords.js'
const foundName = '_places'
const foundFile = `./generated/genex/${foundName}.js`
const missingName = '_placesUnknown'
const missingFile = `./diagnostics/genex/${missingName}.js`

function findVicinities(standardKey) {
    const found = []
    for(let i=0; i<_vicinities.length; i++) {
        const [vicKey, vicEntry] = _vicinities[i]
        const {label, places} = vicEntry
        for (let j=0; j<places.length; j++) {
            if (standardKey.startsWith(places[j])) {
                found.push(vicKey)
                break
            }
        }
    }
    return found
}

// Checks if each PLAC record content is in the MASTER array
function findGedcomPlaceKeys(records, placeMap) {
    const foundMap = new Map([
        ["", ["Not-Stated", []]]
    ])
    const missing = []
    for (let i=0; i<records.length; i++) {
        const data = parseRecord(records[i], i+1)
        if (data) {
            const [level, type, content] = data
            if (type === 'PLAC') {
                const standardKey = placeMap.get(content)
                if (standardKey) {
                    // Get array of vicinities for this place
                    const vicins = findVicinities(standardKey)
                    foundMap.set(content, [standardKey, vicins])
                } else {
                    // console.log(`Missing PLAC key '${content}' at GEDCOM record index ${i}`)
                    missing.push([content, i])
                }
            }
        }
    }
    missing.sort()
    const found = Array.from(foundMap.entries()).sort()
    return [found, missing]
}
function fix(str) { return JSON.stringify(str) }

const map = new Map(_gedcomKnownPlaces)
const [found, missing] = findGedcomPlaceKeys(_filteredRecords, map)

// Write missing PLACes
let head = [
    `// auto-generated by ${progName} on ${new Date().toLocaleString()}`,
    `// from FILTERED GEDCOM JSON records file '${inputFile}'`,
    `// Each element is [<GEDCOM PLAC record content>, <GEDCOM PLAC record index>]`,
    `export const ${missingName} = [`
]
let js = head.join('\n') + '\n'
for(let i=0; i<missing.length; i++) {
    const [content, recordIdx] = missing[i]
    js += `    ["${content}", ${recordIdx}],\n`
}
js += ']\n'
fs.writeFile(missingFile, js, function (err) { if (err) throw err })

// Write all places
head = [`// auto-generated by ${progName} on ${new Date().toLocaleString()}`,
    `// from FILTERED GEDCOM JSON records file '${inputFile}'.`,
    `// Each element is an [<placeName>, [<standardKey>, <arrayIndex>]] array`,
    `export const ${foundName} = [`]
js = head.join('\n') + '\n'
for(let i=0; i<found.length; i++) {
    const [plac, entry] = found[i]
    const [standard, vicins] = entry
    js += `    [${fix(plac)}, [${fix(standard)}, ${i}, ${fix(vicins)}]],\n`
}
js += ']\n'
fs.writeFile(foundFile, js, function (err) { if (err) throw err })
    
console.log(`\n${progName}`)
console.log(`    1 - read ${_filteredRecords.length} [<GEDCOM record>] elements from '${inputFile}'.`)
console.log(`    2 - wrote ${found.length} [<GEDCOM PLAC content>, <standard key>] elements into '${foundFile}'.`)
if (missing.length) {
    console.log(`    3 - wrote ${missing.length} *MISSING* [GEDCOM PLAC content>, <GEDCOM PLAC record index>] elements into '${missingFile}'.`)
    console.log(`    *** These must be hand-entered into the master file '${masterFile}'. ***`)
    console.log(`    Completed with WARNINGS in ${new Date()-time1} msec`)
} else {
    console.log(`    Successfully completed in ${new Date()-time1} msec`)
}
