import fs from 'fs'
import { Auditor } from '../genex/Auditor.js'
import { Genex } from '../genex/Genex.js'

const time1 = new Date()
const progName = (process.argv[1]).split('\\').pop()
const auditName = '_auditResults'
const auditFile = `./diagnostics/genex/${auditName}.js`

const genex = new Genex()
const auditor = new Auditor()

function fix(str) { return JSON.stringify(str) }

const findings = []
for(let i=0; i<genex.people().length; i++) {
    const person = genex.people()[i]
    const report = auditor.audit(person)    // {person, gedKey, nameKey, items}
    if(report.log.length) findings.push(report)
}

// Write Genex _audit.js file
let js = `// auto-generated by ${progName} on ${new Date().toLocaleString()}\n`
+ `export const ${auditName} = [\n`
let items = 0
for(let i=0; i<findings.length; i++) {
    const {person, gedKey, nameKey, log} = findings[i]
    items += log.length
    js += `    [${fix(gedKey)}, ${fix(nameKey)}, [\n`
    for(let j=0; j<log.length; j++) {
        const [code, msg] = log[j]
        js += `        [${fix(code)}, ${fix(msg)}],\n`
    }
    js += `    ]],\n`
}
js += ']\n'
fs.writeFile(auditFile, js, function (err) { if (err) throw err })

console.log(`\n${progName}`)
console.log(`    1 - created Genex with ${genex.people().length} Person and ${genex.family().length} Family instances.`)
console.log(`    2 - wrote ${items} Genex Auditor items for ${findings.length} Persons into '${auditFile}'.`)
console.log(`    Successfully completed in ${new Date()-time1} msec`)
