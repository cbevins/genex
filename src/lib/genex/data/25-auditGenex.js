import fs from 'fs'
import { Auditor } from '../genex/Auditor.js'
import { Genex } from '../genex/Genex.js'
import { Channels } from '../genex/Channels.js'

const time1 = new Date()
const progName = (process.argv[1]).split('\\').pop()
const auditName = '_auditResults'
const auditFile = `./diagnostics/genex/${auditName}.js`

const genex = new Genex()
const auditor = new Auditor()

function fix(str) { return JSON.stringify(str) }

function audit(people) {
    const findings = []
    for(let i=0; i<people.length; i++) {
        const person = people[i]
        const report = auditor.audit(person)    // {person, gedKey, nameKey, items}
        if(report.log.length) findings.push(report)
    }
    return findings
}

console.log(`\n${progName}`)
console.log(`    1 - created Genex with ${genex.people().length} Person and ${genex.family().length} Family instances.`)

const cdbPerson = genex.person('Collin Douglas Bevins 1952')
const cdbAncestors = new Channels(cdbPerson).persons()
const cdbFindings = audit(cdbAncestors)
writeFindings('_auditResultsCdb', cdbFindings, cdbAncestors)

const bjrPerson = genex.person("Barbara Jeanne Riley 1953")
const bjrAncestors = new Channels(bjrPerson).persons()
const bjrFindings = audit(bjrAncestors)
writeFindings('_auditResultsBjr', bjrFindings, bjrAncestors)

const allFindings = audit(genex.people())
writeFindings('_auditResultsAll', allFindings, genex.people())

// Write Genex _audit.js file
function writeFindings(auditName, findings, people) {
    const auditFile = `./diagnostics/genex/${auditName}.js`
    let js = `// auto-generated by ${progName} on ${new Date().toLocaleString()}\n`
        + `// Contains findings for ${findings.length} of ${people.length} Persons:\n`
        + `export const ${auditName} = [\n`
    let items = 0
    for(let i=0; i<findings.length; i++) {
        const {person, gedKey, nameKey, log} = findings[i]
        items += log.length
        js += `    [${fix(gedKey)}, ${fix(nameKey)}, [\n`
        for(let j=0; j<log.length; j++) {
            const [code, msg] = log[j]
            js += `        [${fix(code)}, ${fix(msg)}],\n`
        }
        js += `    ]],\n`
    }
    js += ']\n'
    fs.writeFile(auditFile, js, function (err) { if (err) throw err })
    console.log(`    2 - wrote ${items} Genex Auditor items for ${findings.length} of ${people.length} Persons into '${auditFile}'.`)
}

console.log(`    Successfully completed in ${new Date()-time1} msec`)
