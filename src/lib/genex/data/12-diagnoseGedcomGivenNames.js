import fs from 'fs'
import { parseRecord } from '../gedcom/parseRecord.js'
import { CounterMap } from '../utils/CounterMap.js'
import { Tokenizer } from '../utils/Tokenizer.js'
import { _filteredRecords } from './generated/gedcom/_filteredRecords.js'

const time1 = new Date()
const progName = (process.argv[1]).split('\\').pop()
const inputFile = './generated/gedcom/_filteredRecords.js'
const outputName = '_givenNameCounts'
const outputFile = `./diagnostics/gedcom/${outputName}.js`

const counter = new CounterMap()
const tokenizer = new Tokenizer()

for (let i=0; i<_filteredRecords.length; i++) {
    const data = parseRecord(_filteredRecords[i], i+1)
    if (data) {
        const [level, type, content] = data
        if (type === 'GIVN') {
            const names = tokenizer.tokenize(content)
            if (names.length) counter.add(names[0])
        }
    }
}

const countsByItem = counter.byItem().sort()
const itemsByCount = counter.byCount()
const names = countsByItem

// Write GEDCOM referenced PLACes
const head = [`// auto-generated by ${progName} on ${new Date().toLocaleString()}`,
    `// from FILTERED GEDCOM JSON records file '${inputFile}'.`,
    `// Each element is [<GEDCOM GIVN record content>, <count>]`,
    `export const ${outputName} = [`]
let js = head.join('\n') + '\n'
for(let i=0; i<names.length; i++) {
    const [givn, count] = names[i]
    js += `    [${JSON.stringify(givn)}, ${count}],\n`
}
js += ']\n'
fs.writeFile(outputFile, js, function (err) { if (err) throw err })
    
console.log(`\n${progName}`)
console.log(`    1 - read ${_filteredRecords.length} [<GEDCOM record>] elements from '${inputFile}'.`)
console.log(`    2 - wrote ${names.length} [<GEDCOM PLAC content>, <standard key>] elements into '${outputFile}'.`)
console.log(`    Successfully completed in ${new Date()-time1} msec`)
