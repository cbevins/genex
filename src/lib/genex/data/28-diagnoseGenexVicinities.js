import fs from 'fs'
import { Genex, Channels, Vicinities } from '../genex/index.js'
// Data
import { _places } from '../data/generated/genex/_places.js'
import { _vicinityDefsAll } from './customized/genex/_vicinityDefsAll.js'
import { _vicinityDefsBjr } from './customized/genex/_vicinityDefsBjr.js'
import { _vicinityDefsCdb } from './customized/genex/_vicinityDefsCdb.js'
import { _vicinityDefsBevins } from './customized/genex/_vicinityDefsBevins.js'

const time1 = new Date()
const progName = (process.argv[1]).split('\\').pop()
const genex = new Genex()
const cdb = genex.person('Collin Douglas Bevins 1952')
const wlb = genex.person("William Longford Bevins 1815")
const wab = genex.person("William Alfred Bevins 1843")
const bjr = genex.person("Barbara Jeanne Riley 1953")

// Add Lineages for Bevins-Heddens and Riley-Trombley to each Person
const lineageCdb = new Channels(cdb)
genex.addLineage(lineageCdb, 'Bevins-Heddens', 'BH')

const lineageBjr = new Channels(bjr)
genex.addLineage(lineageBjr, 'Riley-Trombley', 'RT')

function fix(str) { return JSON.stringify(str) }

function vicinityFor(nameKey, vicinDefs, varName) {
    const person = genex.person(nameKey)
    const ancestors = new Channels(person).persons()
    const vicins = new Vicinities(vicinDefs, ancestors)
    const vicArray = vicins.vicinityArray()
    const missing = vicins.missing()
    writeVicins(varName, vicinDefs, vicArray, ancestors, missing)
}

console.log(`\n${progName}`)
console.log(`    1 - created Genex with ${genex.people().length} Person and ${genex.family().length} Family instances.`)

vicinityFor('Collin Douglas Bevins 1952', _vicinityDefsCdb, '_vicinityResultsCdb')
vicinityFor('William Collins Bevins 1931', _vicinityDefsAll, '_vicinityResultsBevins')
vicinityFor("Barbara Jeanne Riley 1953", _vicinityDefsBjr, '_vicinityResultsBjr')

// ALL vicinities
const vicins = new Vicinities(_vicinityDefsAll, genex.people())
const vicArray = vicins.vicinityArray()
const missing = vicins.missing()
writeVicins('_vicinityResultsAll', _vicinityDefsAll, vicArray, genex.people(), missing)

// Write Genex _vicins.js file
function writeVicins(varName, defsArray, vicArray, people, missing=[]) {
    const fileName = `./diagnostics/genex/vicinities/${varName}.js`
    let js = `// auto-generated by ${progName} on ${new Date().toLocaleString()}\n`
        + `// Contains ${vicArray.length} of ${defsArray.length} defined Vicinities for ${people.length} Persons:\n`
        + `// There are ${missing.length} Persons whose Birth Place is not in a known Vicinity.\n`
        + `export const ${varName} = [\n`
    // Loop for each Vicinity
    for(let i=0; i<vicArray.length; i++) {
        const v = vicArray[i]
        js += `    [${fix(v.key())}, ${fix(v.label())}, ${v.persons().size}, [\n`
        // Loop for each Person
        const parr = Array.from(v.persons().entries())
        // for(let j=0; j<v.persons().length; j++) {
        for(let j=0; j<parr.length; j++) {
            const [person, gevents] = parr[j]
            js += `        [${j}, ${fix(person.nameKey())}, ${person.birthYear()}, `
            + `${person.lineageGen()}, ${gevents.length}, [,\n`
            // Loop for each GenEvent
            for(let k=0; k<gevents.length; k++) {
                const gev = gevents[k]
                js += `            [${k}, `
                    + `${fix(gev.type())}, ${gev.date().y()}, `
                    + `${fix(gev.place().standard())}],\n`
            }
            js += '        ]],\n'
        }
        js += '    ]],\n'
    }
    js += ']\n'
    // Format missing birth places
    const ar = []
    for(let i=0; i<missing.length; i++) {
        const p = missing[i]
        ar.push(`// [${p.birthPlaceStandard().padEnd(24)}] ${p.label()}`)
    }
    ar.sort()
    js += `// There are ${missing.length} Persons whose Birth Place is not in a known Vicinity.\n`
    js += ar.join('\n')
    fs.writeFile(fileName, js, function (err) { if (err) throw err })
    console.log(`    2 - wrote ${vicArray.length} of ${defsArray.length} defined Vicinities for ${people.length} Persons into '${fileName}'.`)
}
console.log(`    Successfully completed in ${new Date()-time1} msec`)
