import fs from 'fs'
import { Genex, Channels, Vicinities } from '../genex/index.js'
// Data
import { _places } from '../data/generated/genex/_places.js'
import { _vicinities } from '../data/customized/genex/_vicinities.js'

const time1 = new Date()
const progName = (process.argv[1]).split('\\').pop()
const genex = new Genex()

function fix(str) { return JSON.stringify(str) }

function vicinityFor(nameKey, varName) {
    const person = genex.person(nameKey)
    const ancestors = new Channels(person).persons()
    const vicins = new Vicinities(_vicinities, ancestors)
    const vicArray = vicins.vicinityArray()
    writeVicins(varName, vicArray, ancestors)
}

console.log(`\n${progName}`)
console.log(`    1 - created Genex with ${genex.people().length} Person and ${genex.family().length} Family instances.`)

vicinityFor('Collin Douglas Bevins 1952', '_vicinityResultsCdb')
vicinityFor("Barbara Jeanne Riley 1953", '_vicintyResultBjr')

const vicins = new Vicinities(_vicinities, genex.people())
const vicArray = vicins.vicinityArray()
writeVicins('_vicinityResultsAll', vicArray, genex.people())

// Write Genex _vicins.js file
function writeVicins(varName, vicArray, people) {
    const fileName = `./diagnostics/genex/${varName}.js`
    let js = `// auto-generated by ${progName} on ${new Date().toLocaleString()}\n`
        + `// Contains ${vicArray.length} Places from ${people.length} Persons:\n`
        + `// []\n`
        + `export const ${varName} = [\n`
    for(let i=0; i<vicArray.length; i++) {
        const v = vicArray[i]
        js += `    [${fix(v.key())}, ${fix(v.label())}, ${v.personEvents().length}, [\n`
        for(let j=0; j<v.personEvents().length; j++) {
            const [person, gevents] = v.personEvents()[j]
            js += `        [${j}, ${fix(person.label())}, ${gevents.length}, [,\n`
            for(let k=0; k<gevents.length; k++) {
                const gev = gevents[k]
                js += `            [${k}, ${gev.isMember}, ${fix(gev.vicKey)}, `
                    + `${fix(gev.type())}, ${gev.date().y()}, `
                    + `${fix(gev.place().standard())}],\n`
            }
            js += '        ]],\n'
        }
        js += '    ]],\n'
    }
    js += ']\n'
    fs.writeFile(fileName, js, function (err) { if (err) throw err })
    console.log(`    2 - wrote ${vicArray.length} Vicinity from ${people.length} Persons into '${fileName}'.`)
}
console.log(`    Successfully completed in ${new Date()-time1} msec`)
